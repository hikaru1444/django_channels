<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
</head>
<body>

<div id="example"></div>

<textarea id="chat-log" cols="100" rows="20"></textarea><br>
{{ room_name|json_script:"room-name" }}

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />

<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
        + roomName
        + '/'
    );
    console.log("chatsocket=", chatSocket)

    const container = document.querySelector('#example');

    var hot = new Handsontable(container, {
        data: [
            ['', 'Tesla', 'Volvo', 'Toyota', 'Ford'],
            ['2019', 10, 11, 12, 13],
            ['2020', 20, 11, 14, 13],
            ['2021', 30, 15, 12, 13]
        ],
        rowHeaders: true,
        colHeaders: true,
        height: 'auto',
        licenseKey: 'non-commercial-and-evaluation' // for non-commercial use only
    });

    hot.addHook('afterChange', function(changes, source) {
        console.log("addHook", this.getData(), changes)
        chatSocket.send(JSON.stringify({
            'data': this.getData()
        }));

    });

    chatSocket.onmessage = function (e) {
        console.log("onmessage")
        const data = JSON.parse(e.data);
        document.querySelector('#chat-log').value += (data.message + '\n');
        console.log(data)
        // hot.data = data.data;
        hot.loadData(data.data);
    };
    // 入力後に無限ループになる
    // onmessageかloadDataを変えたら良い感じかも

    /*chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };*/
</script>
</body>
</html>